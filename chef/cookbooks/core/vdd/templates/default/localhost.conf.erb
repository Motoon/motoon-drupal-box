<VirtualHost *:80>
  DocumentRoot /var/www/html
  ServerName localhost
  RewriteEngine On
  ErrorLog /var/log/apache2/error.log
  LogLevel warn
  CustomLog /var/log/apache2/access.log combined
  ServerSignature On
</VirtualHost>

<% @node["vdd"]["sites"].each do |index, site| %>
  <% site["site_stages"].each do |stage| %>
    <VirtualHost *:80>
      DocumentRoot /var/www/<%= index %>/<%= stage %>/docroot
      ServerName <%= stage %>.<%= index %>.local
      ServerAdmin <%= site["account_mail"] %>
      RewriteEngine On
      ErrorLog /var/log/apache2/<%= index %>-<%= stage %>.error.log
      LogLevel warn
      CustomLog /var/log/apache2/<%= index %>-<%= stage %>.access.log combined
      ServerSignature On
      <Directory /var/www/<%= index %>/<%= stage %>/docroot >
        AllowOverride All
      </Directory>
    </VirtualHost>
  <% end %>
<%- end -%>
